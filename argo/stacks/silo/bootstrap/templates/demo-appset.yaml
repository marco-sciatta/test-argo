apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: pool-stack
  namespace: argocd
spec:
  generators:
  - git:
      repoURL: https://github.com/marco-sciatta/test-argo.git
      revision: HEAD
      directories:
      - path: "argo/stacks/{{.Values.stack}}/apps/*"
  template:
    metadata:
      name: "{{.Values.tenant}}-app-{{`{{path.basename}}`}}"
    spec:
      project: default
      source:
        repoURL: https://github.com/marco-sciatta/test-argo.git
        targetRevision: HEAD
        path: "argo/stacks/{{.Values.stack}}/apps/{{`{{path.basename}}`}}"
        helm:
          # Release name override (defaults to application name)
          releaseName: "{{`{{path.basename}}`}}"
          valueFiles:
          - "values.yaml"
          - "../../../../envs/{{.Values.environment}}/{{.Values.stack}}/{{`{{path.basename}}`}}/values.yaml"
          values: |
            tenant: {{.Values.tenant}}
            stack: {{.Values.stack}}
            project: {{.Values.project}}
            env: {{.Values.env}}
      destination:
        # Default base cluster
        name: in-cluster
        namespace: {{.Values.tenant}}
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=false
          - ApplyOutOfSyncOnly=true


